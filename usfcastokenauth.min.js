/**
 * USF Service for CAS backed Token Authentication
 * @version v0.0.1-1n - 2014-07-07 * @link https://github.com/jamjon3/UsfCAStokenAuth
 * @author James Jones <jamjon3@gmail.com>
 * @license Lesser GPL License, http://www.gnu.org/licenses/lgpl.html
 */!function(a,b,c){"use strict";c.module("UsfCAStokenAuth",["angularLocalStorage"]).factory("tokenAuth",["$rootScope","$injector","storage","$window","$q","$log","$cookieStore","$cookies","$resource","UsfCAStokenAuthConstant",function(b,d,e,f,g,h,i,j,k,l){var m=function(b,c){var d=c();return d["Content-type"]="application/x-www-form-urlencoded; charset=utf-8",a.param(b)},n={initializeStorage:function(){var a={};a[l.applicationUniqueId]={buffer:[],applicationResources:{}},e.bind(b,"tokenAuth",{defaultValue:a}),c.forEach(l.applicationResources,function(a,c){c in b.tokenAuth[l.applicationUniqueId].applicationResources||(b.tokenAuth[l.applicationUniqueId].applicationResources[c]={url:a})})},getApplicationResourceKey:function(a){var b=!0,d="";return c.forEach(l.applicationResources,function(c,e){b&&a===c&&(d=e,b=!1)}),d},transformRequestAsFormPost:m,requestToken:function(a){return h.info("Requesting Token: "+b.tokenAuth[l.applicationUniqueId].applicationResources[a].tokenService+"/request"),h.info("App ID: "+b.tokenAuth[l.applicationUniqueId].applicationResources[a].appId),h.info({cookies:j}),k(b.tokenAuth[l.applicationUniqueId].applicationResources[a].tokenService+"/request",{},{getToken:{method:"GET",responseType:"json",withCredentials:!0,params:{service:decodeURIComponent(b.tokenAuth[l.applicationUniqueId].applicationResources[a].appId)}}}).getToken().$promise}};return b.$on("event:auth-loginRequired",function(){h.info(b.tokenAuth[l.applicationUniqueId].buffer.slice(-1)[0].config.data),f.alert("Temporary Stop before the redirect to the tokenService!"),f.location.assign(b.tokenAuth[l.applicationUniqueId].buffer.slice(-1)[0].config.data.tokenService)}),b.$on("event:auth-tokenRequired",function(){n.requestToken().then(function(a){b[b.tokenAuth[l.applicationUniqueId].buffer.slice(-1)[0].config.params.service].token=a.token},function(a){h.info(a)})}),n}]).config(["$httpProvider","$resourceProvider","$injector",function(a,b){b.defaults.stripTrailingSlashes=!1,a.defaults.useXDomain=!0,a.defaults.withCredentials=!0,delete a.defaults.headers.common["X-Requested-With"],a.interceptors.push(["$rootScope","$q","$window","$log","UsfCAStokenAuthConstant",function(a,b,d,e,f){var g=function(a){var b=!0,d="";return c.forEach(f.applicationResources,function(c,e){b&&a===c&&(d=e,b=!1)}),d};return{request:function(a){return a||b.when(a)},requestError:function(a){return e.info(a),b.reject(a)},response:function(a){return a||b.when(a)},responseError:function(d){e.info(d);var h=b.defer();if(401!==d.status||d.config.ignoreAuthModule)return e.info({Rejection:d}),h.promise;d.config.data=d.data,a.tokenAuth[f.applicationUniqueId].buffer.push({config:d.config,deferred:h});var i={getParams:function(a){var b,c,d,e,f={};for(b=a.split("&"),d=0,e=b.length;e>d;d++)c=b[d].split("="),f[c[0]]=decodeURIComponent(c[1]);return f}}.getParams(d.data.tokenService.substring(d.data.tokenService.indexOf("?")+1)),j=g(d.config.url);return c.forEach({appId:i.service,tokenService:{removeLogin:function(a){var b=a.lastIndexOf("/");return b>a.indexOf("/")+1?a.substr(0,b):a}}.removeLogin(d.data.tokenService.substring(0,d.data.tokenService.indexOf("?")))},function(b,c){a.tokenAuth[f.applicationUniqueId].applicationResources[j][c]=b}),a.$broadcast("event:auth-loginRequired"),h.promise}}}])}]).run(["$rootScope","$log","$window","storage","tokenAuth","UsfCAStokenAuthConstant",function(a,b,c,d,e,f){if(e.initializeStorage(),a.tokenAuth[f.applicationUniqueId].buffer.length){var g=a.tokenAuth[f.applicationUniqueId].buffer.slice(-1)[0].config,h=e.getApplicationResourceKey(g.url);"appId"in a.tokenAuth[f.applicationUniqueId].applicationResources[h]&&"tokenService"in a.tokenAuth[f.applicationUniqueId].applicationResources[h]&&!("token"in a.tokenAuth[f.applicationUniqueId].applicationResources[h])&&e.requestToken(h).then(function(c){c.$promise.then(function(a){b.info({tokenobj:a})}),b.info({requestTokenData:c}),a.tokenAuth[f.applicationUniqueId].applicationResources[h].token=c.token,a.tokenAuth[f.applicationUniqueId].buffer.pop()},function(a){c.alert("Cors problem 302"),b.info(a)})}}])}(jQuery,window,window.angular);