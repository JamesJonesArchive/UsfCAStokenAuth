/**
 * USF Service for CAS backed Token Authentication
 * @version v0.0.1-1b - 2014-06-26 * @link https://github.com/jamjon3/UsfCAStokenAuth
 * @author James Jones <jamjon3@gmail.com>
 * @license Lesser GPL License, http://www.gnu.org/licenses/lgpl.html
 */!function(a,b){"use strict";b.module("UsfCAStokenAuth",[]).factory("tokenAuth",["$rootScope","$injector","storage","$window","$q","$log","$cookieStore","$cookies","$resource","applicationResources",function(a,c,d,e,f,g,h,i,j,k){var l={initializeStorage:function(){d.bind(a,"tokenAuth",{defaultValue:{buffer:[],applicationResources:{}}}),b.forEach(k,function(b,c){c in a.tokenAuth.applicationResources||(a.tokenAuth.applicationResources[c]={url:b})})},getApplicationResourceKey:function(a){var c=!0,d="";return b.forEach(k,function(b,e){c&&a===b&&(d=e,c=!1)}),d},requestToken:function(b){return g.info("Requesting Token: "+a.tokenAuth.applicationResources[b].tokenService+"/request"),g.info("App ID: "+a.tokenAuth.applicationResources[b].appId),g.info({cookies:i}),j(a.tokenAuth.applicationResources[b].tokenService+"/request",{},{getToken:{method:"POST",responseType:"json",withCredentials:!0,headers:{"Content-Type":"application/json",Accept:"application/json"}}}).getToken({service:a.tokenAuth.applicationResources[b].appId}).$promise}};return a.$on("event:auth-loginRequired",function(){g.info(a.tokenAuth.buffer.slice(-1)[0].config.data),e.alert("Temporary Stop before the redirect to the tokenService!"),e.location.assign(a.tokenAuth.buffer.slice(-1)[0].config.data.tokenService)}),a.$on("event:auth-tokenRequired",function(){l.requestToken().then(function(b){a[a.tokenAuth.buffer.slice(-1)[0].config.params.service].token=b.token},function(a){g.info(a)})}),l}]).config(["$httpProvider","$resourceProvider","$injector",function(a){a.interceptors.push(["$rootScope","$q","$window","$log","applicationResources",function(a,c,d,e,f){var g=function(a){var c=!0,d="";return b.forEach(f,function(b,e){c&&a===b&&(d=e,c=!1)}),d};return{request:function(a){return a||c.when(a)},requestError:function(a){return e.info(a),c.reject(a)},response:function(a){return a||c.when(a)},responseError:function(f){e.info(f);var h=c.defer();if(401!==f.status||f.config.ignoreAuthModule)return e.info(f),d.alert("Rejection status is "+f.status),h.promise;f.config.data=f.data,a.tokenAuth.buffer.push({config:f.config,deferred:h});var i={getParams:function(a){var b,c,d,e,f={};for(b=a.split("&"),d=0,e=b.length;e>d;d++)c=b[d].split("="),f[c[0]]=decodeURIComponent(c[1]);return f}}.getParams(f.data.tokenService.substring(f.data.tokenService.indexOf("?")+1)),j=g(f.config.url);return b.forEach({appId:i.service,tokenService:{removeLogin:function(a){var b=a.lastIndexOf("/");return b>a.indexOf("/")+1?a.substr(0,b):a}}.removeLogin(f.data.tokenService.substring(0,f.data.tokenService.indexOf("?")))},function(b,c){a.tokenAuth.applicationResources[j][c]=b}),a.$broadcast("event:auth-loginRequired"),h.promise}}}])}]).run(["$rootScope","$log","$window","storage","tokenAuth","applicationResources",function(a,b,c,d,e){if(e.initializeStorage(),a.tokenAuth.buffer.length){var f=a.tokenAuth.buffer.slice(-1)[0].config,g=e.getApplicationResourceKey(f.url);"appId"in a.tokenAuth.applicationResources[g]&&"tokenService"in a.tokenAuth.applicationResources[g]&&!("token"in a.tokenAuth.applicationResources[g])&&e.requestToken(g).then(function(c){c.$promise.then(function(a){b.info({tokenobj:a})}),b.info({requestTokenData:c}),a.tokenAuth.applicationResources[g].token=c.token,a.tokenAuth.buffer.pop()},function(a){c.alert("Cors problem 302"),b.info(a)})}}])}(window,window.angular);