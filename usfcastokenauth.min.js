/**
 * USF Service for CAS backed Token Authentication
 * @version v0.0.24 - 2015-03-11 * @link https://github.com/jamjon3/UsfCAStokenAuth
 * @author James Jones <jamjon3@gmail.com>
 * @license Lesser GPL License, http://www.gnu.org/licenses/lgpl.html
 */!function(a,b,c){"use strict";c.module("UsfCAStokenAuth",["ngRoute","ngResource","ngCookies","angularLocalStorage"]).factory("tokenAuth",["$rootScope","$injector","storage","$window","$location","$q","$log","$cookieStore","$cookies","$resource","$http","UsfCAStokenAuthConstant",function(a,b,d,e,f,g,h,i,j,k,l,UsfCAStokenAuthConstant){var m={isDebugEnabled:function(){return"debug"in UsfCAStokenAuthConstant?UsfCAStokenAuthConstant.debug===!0:!1},initializeStorage:function(){var b={};b[UsfCAStokenAuthConstant.applicationUniqueId]={buffer:[],applicationResources:{}},d.bind(a,"tokenAuth",{defaultValue:b});var e=i.get(UsfCAStokenAuthConstant.applicationUniqueId);"undefined"==typeof e&&m.clearTokens(),m.isDebugEnabled()&&(e=i.get(UsfCAStokenAuthConstant.applicationUniqueId),h.info({cookieValue:e,applicationId:UsfCAStokenAuthConstant.applicationUniqueId})),UsfCAStokenAuthConstant.applicationUniqueId in a.tokenAuth||(a.tokenAuth[UsfCAStokenAuthConstant.applicationUniqueId]=b[UsfCAStokenAuthConstant.applicationUniqueId]),c.forEach(UsfCAStokenAuthConstant.applicationResources,function(b,c){c in a.tokenAuth[UsfCAStokenAuthConstant.applicationUniqueId].applicationResources||(a.tokenAuth[UsfCAStokenAuthConstant.applicationUniqueId].applicationResources[c]={url:b})})},getTokenKey:function(a){var b=this,d=!0,e="";return c.forEach(UsfCAStokenAuthConstant.applicationResources,function(b,c){d&&a===b&&(e=c,d=!1)}),b.isDebugEnabled()&&h.info({matchedAppKey:e}),e},getStoredToken:function(b){return"token"in a.tokenAuth[UsfCAStokenAuthConstant.applicationUniqueId].applicationResources[b]?a.tokenAuth[UsfCAStokenAuthConstant.applicationUniqueId].applicationResources[b].token:""},getResourceUrl:function(a){return UsfCAStokenAuthConstant.applicationResources[a]},clearToken:function(b){b in a.tokenAuth[UsfCAStokenAuthConstant.applicationUniqueId].applicationResources&&"token"in a.tokenAuth[UsfCAStokenAuthConstant.applicationUniqueId].applicationResources[b]&&delete a.tokenAuth[UsfCAStokenAuthConstant.applicationUniqueId].applicationResources[b].token},clearTokens:function(){c.forEach(a.tokenAuth[UsfCAStokenAuthConstant.applicationUniqueId].applicationResources,function(b,c){"token"in b&&delete a.tokenAuth[UsfCAStokenAuthConstant.applicationUniqueId].applicationResources[c].token})},clearLocalStorage:function(){d.clearAll()},sessionLogout:function(){var b=i.get(UsfCAStokenAuthConstant.applicationUniqueId);if("undefined"!=typeof b){i.remove(UsfCAStokenAuthConstant.applicationUniqueId);var d=[],j=[];c.forEach(a.tokenAuth[UsfCAStokenAuthConstant.applicationUniqueId].applicationResources,function(a){"tokenService"in a&&-1==j.indexOf(a.tokenService)&&j.push(a.tokenService)}),m.isDebugEnabled()&&h.info({tokenServices:j}),c.forEach(j,function(a){var b={getRootAuthTransfer:function(a){var b=a.lastIndexOf("/");return b>a.indexOf("/")+1?a.substr(0,b):a}}.getRootAuthTransfer(a)+"/logout";m.isDebugEnabled()&&h.info("Adding promise for: "+b),d.push(l({method:"GET",url:b}))}),g.all(d).then(function(){m.clearTokens(),f.path(UsfCAStokenAuthConstant.logoutRoute)}),e.location.reload()}},isLoggedIn:function(){var a=i.get(UsfCAStokenAuthConstant.applicationUniqueId);return"undefined"!=typeof a},hasToken:function(b){return b in a.tokenAuth[UsfCAStokenAuthConstant.applicationUniqueId].applicationResources?"token"in a.tokenAuth[UsfCAStokenAuthConstant.applicationUniqueId].applicationResources[b]:!1},requestToken:function(b){var c=this;return k(a.tokenAuth[UsfCAStokenAuthConstant.applicationUniqueId].applicationResources[b].tokenService+"/request",{},{getToken:{method:"POST",withCredentials:!0,responseType:"text",headers:{"Content-Type":"application/json"},transformResponse:function(a,b){var d=b();return c.isDebugEnabled()&&(h.info(d),h.info({transformedResponse:a})),{token:a}}}}).getToken({service:a.tokenAuth[UsfCAStokenAuthConstant.applicationUniqueId].applicationResources[b].appId}).$promise}};return a.$on("event:auth-loginRequired",function(){m.isDebugEnabled()&&h.info(a.tokenAuth[UsfCAStokenAuthConstant.applicationUniqueId].buffer.slice(-1)[0].config.data),e.location.assign(a.tokenAuth[UsfCAStokenAuthConstant.applicationUniqueId].buffer.slice(-1)[0].config.data.tokenService)}),a.$on("event:auth-unauthorizedRedirect",function(){f.path(UsfCAStokenAuthConstant.unauthorizedRoute)}),a.$on("event:tokenAuthLogout",function(){m.sessionLogout()}),a.$on("event:tokenAuthLogin",function(){"loginRoute"in UsfCAStokenAuthConstant&&f.path(UsfCAStokenAuthConstant.loginRoute),e.location.reload()}),m}]).config(["$httpProvider","$resourceProvider","$injector",function(a,b){"defaults"in b&&(b.defaults.stripTrailingSlashes=!1),a.defaults.useXDomain=!0,a.defaults.withCredentials=!0,delete a.defaults.headers.common["X-Requested-With"],a.interceptors.push(["$rootScope","$q","$window","$location","$log","UsfCAStokenAuthConstant",function(a,b,d,e,f,UsfCAStokenAuthConstant){var g=function(){return"debug"in UsfCAStokenAuthConstant?UsfCAStokenAuthConstant.debug===!0:!1},h=function(a){var b=!0,d="";return c.forEach(UsfCAStokenAuthConstant.applicationResources,function(c,e){b&&a===c&&(d=e,b=!1)}),g()&&f.info({matchedAppKey:d}),d},i=function(a){return UsfCAStokenAuthConstant.applicationResources[a]},j=function(b){return"token"in a.tokenAuth[UsfCAStokenAuthConstant.applicationUniqueId].applicationResources[b]?a.tokenAuth[UsfCAStokenAuthConstant.applicationUniqueId].applicationResources[b].token:""};return{request:function(a){if("ignoreAuthModule"in a||(a.ignoreAuthModule=!1),!a.ignoreAuthModule){var c="";if("tokenKey"in a)"url"in a||(a.url=i(a.tokenKey)),c=j(a.tokenKey),c.length>1&&("headers"in a?"X-Auth-Token"in a.headers||(a.headers["X-Auth-Token"]=c):a.headers={"X-Auth-Token":c});else if("url"in a){var d=h(a.url);d.length>0&&(a.tokenKey=d,c=j(a.tokenKey),c.length>1&&("headers"in a?"X-Auth-Token"in a.headers||(a.headers["X-Auth-Token"]=c):a.headers={"X-Auth-Token":c}))}}return a||b.when(a)},requestError:function(a){return g()&&f.info(a),b.reject(a)},response:function(a){return a||b.when(a)},responseError:function(d){g()&&f.info(d);var e=b.defer();if(401===d.status&&!d.config.ignoreAuthModule&&"tokenKey"in d.config){if(d.config.data=d.data,"authorizedError"in d.data)a.authorizedError=d.data.authorizedError,a.unauthorizedRole=d.data.role,a.$broadcast("event:auth-unauthorizedRedirect");else{a.tokenAuth[UsfCAStokenAuthConstant.applicationUniqueId].buffer.push({config:d.config,deferred:e});var h={getParams:function(a){var b,c,d,e,f={};for(b=a.split("&"),d=0,e=b.length;e>d;d++)c=b[d].split("="),f[c[0]]=decodeURIComponent(c[1]);return f}}.getParams(d.data.tokenService.substring(d.data.tokenService.indexOf("?")+1)),i=d.config.tokenKey;c.forEach({appId:h.service,tokenService:{removeLogin:function(a){var b=a.lastIndexOf("/");return b>a.indexOf("/")+1?a.substr(0,b):a}}.removeLogin(d.data.tokenService.substring(0,d.data.tokenService.indexOf("?")))},function(b,c){a.tokenAuth[UsfCAStokenAuthConstant.applicationUniqueId].applicationResources[i][c]=b}),a.$broadcast("event:auth-loginRequired")}return e.promise}return g()&&f.info({Rejection:d}),e.promise}}}])}]).run(["$rootScope","$log","$window","$cookieStore","storage","tokenAuth","UsfCAStokenAuthConstant",function(a,b,c,d,e,f,UsfCAStokenAuthConstant){f.initializeStorage(),a.tokenAuthLogout=function(){a.$broadcast("event:tokenAuthLogout")},a.tokenAuthLogin=function(){a.$broadcast("event:tokenAuthLogin")},a.isTokenAuth=function(){return f.isLoggedIn()};for(var g={error:function(a){f.isDebugEnabled()&&b.info(a)},tokenHandler:function(c){f.isDebugEnabled()&&b.info({requestTokenData:c}),a.tokenAuth[UsfCAStokenAuthConstant.applicationUniqueId].applicationResources[j].token=c.token;var e=d.get(UsfCAStokenAuthConstant.applicationUniqueId);"undefined"==typeof e&&(d.put(UsfCAStokenAuthConstant.applicationUniqueId,(new Date).getTime()),a.tokenAuth[UsfCAStokenAuthConstant.applicationUniqueId].buffer.length>0&&a.tokenAuth[UsfCAStokenAuthConstant.applicationUniqueId].buffer.pop(),a.$broadcast("event:tokenAuthLogin"))},promises:{}},h=a.tokenAuth[UsfCAStokenAuthConstant.applicationUniqueId].buffer.length-1;h>=0;h--){var i=a.tokenAuth[UsfCAStokenAuthConstant.applicationUniqueId].buffer[h].config,j=i.tokenKey;f.isDebugEnabled()&&b.info({bufferIndex:h,config:i,tokenKey:j}),"appId"in a.tokenAuth[UsfCAStokenAuthConstant.applicationUniqueId].applicationResources[j]&&"tokenService"in a.tokenAuth[UsfCAStokenAuthConstant.applicationUniqueId].applicationResources[j]&&f.requestToken(j).then(g.tokenHandler,g.error)}for(;a.tokenAuth[UsfCAStokenAuthConstant.applicationUniqueId].buffer.length>0;)a.tokenAuth[UsfCAStokenAuthConstant.applicationUniqueId].buffer.pop()}])}(jQuery,window,window.angular);