/**
 * USF Service for CAS backed Token Authentication
 * @version v1.0.0 - 2016-01-27
 * @link https://github.com/jamjon3/UsfCAStokenAuth
 * @author James Jones <jamjon3@gmail.com>
 * @license Apache 2.0 License, https://opensource.org/licenses/Apache-2.0
 */!function(a,b,c){b.module("UsfCAStokenAuth",["ngRoute","ngResource","ngCookies","angularLocalStorage"]).factory("tokenAuth",["$rootScope","$rootElement","storage","$cookies","$log","$q","$location","$injector","$resource","$window","$filter","$http",function(a,c,d,e,f,g,h,i,j,k,l,m){var n={initializeStorage:function(){var b={};b[n.getAppName()]={buffer:[],applicationResources:{}},d.bind(a,"tokenAuth",{defaultValue:b}),n.getAppName()in a.tokenAuth||(a.tokenAuth[n.getAppName()]=b[n.getAppName()]);var c=e.get(n.getAppName());"undefined"==typeof c&&n.clearTokens(),n.isDebugEnabled()&&(c=e.get(n.getAppName()),f.info({cookieValue:c,appName:n.getAppName()}))},getStoredToken:function(b){return b in a.tokenAuth[n.getAppName()].applicationResources&&"token"in a.tokenAuth[n.getAppName()].applicationResources[b]?a.tokenAuth[n.getAppName()].applicationResources[b].token:""},sessionLogout:function(){if(n.isLoggedIn()){e.remove(n.getAppName());var c=[],d=[];b.forEach(a.tokenAuth[n.getAppName()].applicationResources,function(a){"tokenService"in a&&-1===d.indexOf(a.tokenService)&&d.push(a.tokenService)}),n.isDebugEnabled()&&f.info({tokenServices:d}),b.forEach(d,function(a){var b=l("tokenAuth_generateLogoutURL")(a);n.isDebugEnabled()&&f.info("Adding promise for: "+b),c.push(m({method:"GET",url:b}))}),g.all(c).then(function(a){n.clearTokens(),h.path(n.getLogoutRoute())})}},hasToken:function(b){return b in a.tokenAuth[n.getAppName()].applicationResources?"token"in a.tokenAuth[n.getAppName()].applicationResources[b]:!1},requestToken:function(b){var c=this;return j(a.tokenAuth[n.getAppName()].applicationResources[b].tokenService+"/request",{},{getToken:{method:"POST",withCredentials:!0,responseType:"text",headers:{"Content-Type":"application/json"},transformResponse:function(a,b){var d=b();return c.isDebugEnabled()&&(f.info(d),f.info({transformedResponse:a})),{token:a}}}}).getToken({service:a.tokenAuth[n.getAppName()].applicationResources[b].appId}).$promise},clearTokens:function(){b.forEach(a.tokenAuth[n.getAppName()].applicationResources,function(b,c){"token"in b&&delete a.tokenAuth[n.getAppName()].applicationResources[c].token})},clearToken:function(b){b in a.tokenAuth[n.getAppName()].applicationResources&&"token"in a.tokenAuth[n.getAppName()].applicationResources[b]&&delete a.tokenAuth[n.getAppName()].applicationResources[b].token},clearLocalStorage:function(){d.clearAll()},getLogoutRoute:function(){if(i.has("UsfCAStokenAuthConstant")){var a=i.get("UsfCAStokenAuthConstant");if("logoutRoute"in a)return a.logoutRoute}return"/logout"},getLoginRoute:function(){if(i.has("UsfCAStokenAuthConstant")){var a=i.get("UsfCAStokenAuthConstant");if("loginRoute"in a)return a.loginRoute}return"/login"},getUnauthorizedRoute:function(){if(i.has("UsfCAStokenAuthConstant")){var a=i.get("UsfCAStokenAuthConstant");if("unauthorizedRoute"in a)return a.unauthorizedRoute}return"/unauthorized"},getAppName:function(){return c.attr("ng-app")},isDebugEnabled:function(){if(i.has("UsfCAStokenAuthConstant")){var a=i.get("UsfCAStokenAuthConstant");if("debug"in a)return a.debug}return!1},isLoggedIn:function(){var a=e.get(n.getAppName());return n.isDebugEnabled()&&(f.info({sessionCookie:a}),f.info({isLoggedIn:"undefined"!=typeof a})),"undefined"!=typeof a}};return a.$on("event:auth-loginRequired",function(){n.isDebugEnabled()&&f.info(a.tokenAuth[n.getAppName()].buffer.slice(-1)[0].config.data),k.location.assign(a.tokenAuth[n.getAppName()].buffer.slice(-1)[0].config.data.tokenService)}),a.$on("event:auth-unauthorizedRedirect",function(){h.path(n.getUnauthorizedRoute())}),a.$on("event:tokenAuthLogout",function(){n.sessionLogout()}),a.$on("event:tokenAuthLogin",function(){if(i.has("UsfCAStokenAuthConstant")){var a=i.get("UsfCAStokenAuthConstant");"loginRoute"in a?h.path(a.loginRoute):k.location.reload()}else k.location.reload()}),n}]),b.module("UsfCAStokenAuth").filter("tokenAuth_generateLogoutURL",function(){return function(a){return{getRootAuthTransfer:function(a){var b=a.lastIndexOf("/");return b>a.indexOf("/")+1?a.substr(0,b):a}}.getRootAuthTransfer(a)+"/logout"}}),b.module("UsfCAStokenAuth").filter("tokenAuth_queryStringParams",function(){return function(a){return{getParams:function(a){var b,c,d,e,f={};for(b=a.split("&"),d=0,e=b.length;e>d;d++)c=b[d].split("="),f[c[0]]=decodeURIComponent(c[1]);return f}}.getParams(a.substring(a.indexOf("?")+1))}}),b.module("UsfCAStokenAuth").filter("tokenAuth_filterTokenRequestBuffer",[function(){return function(a,c){var d=[],e=[];return b.forEach(a,function(a,b){var f=a.config,g=f.tokenKey;"appId"in c[g]&&"tokenService"in c[g]&&-1===e.indexOf(g)&&(e.push(g),d.push(a))}),d}}]),b.module("UsfCAStokenAuth").factory("tokenAuth_interceptor",["$rootScope","$q","$log","$filter","$rootElement","$injector",function(a,c,d,e,f,g){var h={getStoredToken:function(b){return b in a.tokenAuth[h.getAppName()].applicationResources&&"token"in a.tokenAuth[h.getAppName()].applicationResources[b]?a.tokenAuth[h.getAppName()].applicationResources[b].token:""},isDebugEnabled:function(){if(g.has("UsfCAStokenAuthConstant")){var a=g.get("UsfCAStokenAuthConstant");if("debug"in a)return a.debug}return!1},getAppName:function(){return f.attr("ng-app")}};return{request:function(a){if("tokenKey"in a){var b=h.getStoredToken(a.tokenKey);b.length>1&&("headers"in a?"X-Auth-Token"in a.headers||(a.headers["X-Auth-Token"]=b):a.headers={"X-Auth-Token":b})}return a||c.when(a)},requestError:function(a){return h.isDebugEnabled()&&d.info(a),c.reject(a)},response:function(a){return a||c.when(a)},responseError:function(f){h.isDebugEnabled()&&d.info(f);var g=c.defer();if(401===f.status&&"tokenKey"in f.config){if(f.config.data=f.data,"authorizedError"in f.data)a.authorizedError=f.data.authorizedError,a.unauthorizedRole=f.data.role,a.$broadcast("event:auth-unauthorizedRedirect");else{a.tokenAuth[h.getAppName()].buffer.push({config:f.config,deferred:g});var i=e("tokenAuth_queryStringParams")(f.data.tokenService),j=f.config.tokenKey;j in a.tokenAuth[h.getAppName()].applicationResources||(a.tokenAuth[h.getAppName()].applicationResources[j]={}),b.forEach({appId:i.service,tokenService:{removeLogin:function(a){var b=a.lastIndexOf("/");return b>a.indexOf("/")+1?a.substr(0,b):a}}.removeLogin(f.data.tokenService.substring(0,f.data.tokenService.indexOf("?")))},function(b,c){a.tokenAuth[h.getAppName()].applicationResources[j][c]=b}),a.$broadcast("event:auth-loginRequired")}return g.promise}return h.isDebugEnabled()&&d.info({Rejection:f}),c.reject(f)}}}]),b.module("UsfCAStokenAuth").config(["$httpProvider","$resourceProvider",function(a,b){"defaults"in b&&(b.defaults.stripTrailingSlashes=!1),a.defaults.useXDomain=!0,a.defaults.withCredentials=!0,delete a.defaults.headers.common["X-Requested-With"],a.interceptors.push("tokenAuth_interceptor")}]).run(["$rootScope","$log","$window","$location","$cookies","$injector","$q","$filter","tokenAuth",function(a,c,d,e,f,g,h,i,j){j.initializeStorage(),a.$on("$locationChangeStart",function(b,f,h){var i=e.path(),k=[j.getLogoutRoute()];if(g.has("UsfCAStokenAuthConstant")){var l=g.get("UsfCAStokenAuthConstant");"loginRoute"in l&&k.push(l.loginRoute)}j.isDebugEnabled()&&(c.info("$locationChangeStart interception"),c.info({nextPath:i,matchingPaths:k}),c.info({authenticated:j.isLoggedIn()})),f!==h&&-1!==k.indexOf(i)&&(j.isDebugEnabled()&&c.info("$locationChangeStart path matched on: "+i+" which is "+f),a.$evalAsync(function(){d.location.assign(f)}))}),a.tokenAuthLogout=function(){a.$broadcast("event:tokenAuthLogout")},a.tokenAuthLogin=function(){a.$broadcast("event:tokenAuthLogin")},a.isTokenAuth=function(){return j.isLoggedIn()};var k={};b.forEach(i("tokenAuth_filterTokenRequestBuffer")(a.tokenAuth[j.getAppName()].buffer,a.tokenAuth[j.getAppName()].applicationResources),function(a,b){k[a.config.tokenKey]=j.requestToken(a.config.tokenKey)}),h.all(k).then(function(d){b.forEach(d,function(b,d){j.isDebugEnabled()&&c.info({requestTokenData:b}),a.tokenAuth[j.getAppName()].applicationResources[d].token=b.token}),a.tokenAuth[j.getAppName()].buffer.length=0;var e=f.get(j.getAppName());"undefined"==typeof e&&(f.put(j.getAppName(),(new Date).getTime()),a.$broadcast("event:tokenAuthLogin"))},function(a){j.isDebugEnabled()&&c.info(a)})}])}(window,window.angular);